<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS 服务测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TTS 服务测试</h1>

        <div class="form-group">
            <label>TTS 服务地址:</label>
            <input type="text" id="ttsUrl" value="https://u861448-ej47-562de107.bjb2.seetacloud.com:8443" placeholder="https://your-tts-service.com">
        </div>

        <div class="form-group">
            <label>API Key (可选):</label>
            <input type="text" id="apiKey" placeholder="your_api_key">
        </div>

        <div class="form-group">
            <label>后端类型:</label>
            <select id="backend">
                <option value="vllm">VLLM (Gradio)</option>
                <option value="legacy">Legacy</option>
            </select>
        </div>

        <button onclick="testConnection()">测试连接</button>
        <button onclick="saveSettings()" id="saveBtn" disabled>保存设置</button>

        <div id="result"></div>
    </div>

    <script>
        async function testConnection() {
            const resultDiv = document.getElementById('result');
            const ttsUrl = document.getElementById('ttsUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const backend = document.getElementById('backend').value;

            if (!ttsUrl) {
                showResult('error', '请输入 TTS 服务地址');
                return;
            }

            showResult('loading', '正在测试连接...');

            try {
                // Test different endpoints
                const testEndpoints = [
                    { path: '/', name: '根路径' },
                    { path: '/gradio_api/info', name: 'Gradio API 信息' },
                    { path: '/docs', name: 'FastAPI 文档' },
                    { path: '/health', name: '健康检查' }
                ];

                let connected = false;
                let serviceType = 'Unknown';

                for (const endpoint of testEndpoints) {
                    try {
                        const testUrl = ttsUrl + endpoint.path;
                        const headers = {};
                        if (apiKey) {
                            headers['Authorization'] = `Bearer ${apiKey}`;
                        }

                        const response = await fetch(testUrl, {
                            method: 'GET',
                            headers: headers,
                            mode: 'cors'
                        });

                        if (response.ok) {
                            const text = await response.text();

                            if (endpoint.path === '/' && text.toLowerCase().includes('gradio')) {
                                serviceType = 'Gradio IndexTTS2';
                                connected = true;
                                break;
                            } else if (endpoint.path === '/gradio_api/info') {
                                serviceType = 'Gradio IndexTTS2';
                                connected = true;
                                break;
                            } else if (endpoint.path === '/docs' && text.includes('FastAPI')) {
                                serviceType = 'FastAPI TTS';
                                connected = true;
                                break;
                            } else if (endpoint.path === '/health') {
                                serviceType = '标准 TTS 服务';
                                connected = true;
                                break;
                            }
                        }
                    } catch (err) {
                        console.log(`测试 ${endpoint.name} 失败:`, err);
                    }
                }

                if (connected) {
                    showResult('success', `连接成功！检测到服务类型: ${serviceType}`);
                    document.getElementById('saveBtn').disabled = false;
                } else {
                    showResult('error', '连接失败，请检查服务地址和网络连接');
                    document.getElementById('saveBtn').disabled = true;
                }

            } catch (error) {
                showResult('error', `测试失败: ${error.message}`);
                document.getElementById('saveBtn').disabled = true;
            }
        }

        async function saveSettings() {
            const settings = {
                tts: {
                    service_url: document.getElementById('ttsUrl').value,
                    api_key: document.getElementById('apiKey').value,
                    backend: document.getElementById('backend').value
                }
            };

            showResult('loading', '正在保存设置...');

            try {
                const response = await fetch('/api/v1/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (response.ok && data.code === 0) {
                    showResult('success', '设置已保存到服务器');
                } else {
                    showResult('error', `保存失败: ${data.message || '未知错误'}`);
                }
            } catch (error) {
                showResult('error', `保存失败: ${error.message}`);
            }
        }

        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        // Load current settings on page load
        window.onload = async function() {
            try {
                const response = await fetch('/api/v1/settings');
                const data = await response.json();

                if (response.ok && data.code === 0) {
                    const tts = data.data.tts || {};
                    if (tts.service_url) {
                        document.getElementById('ttsUrl').value = tts.service_url;
                    }
                    if (tts.api_key) {
                        document.getElementById('apiKey').value = tts.api_key;
                    }
                    if (tts.backend) {
                        document.getElementById('backend').value = tts.backend;
                    }
                }
            } catch (error) {
                console.log('加载当前设置失败:', error);
            }
        };
    </script>
</body>
</html>