# Video Auto Dubbing - Optimization & Refactoring Report (Feb 2026)

## 1. Core Problem Solution: Voice Cloning & Real-time Synthesis
**Issue**: The previous implementation failed to invoke the correct `qwen3-tts-vc-realtime` model for voice cloning, falling back to standard voices or failing with "No segments provided".
**Solution**:
- **Protocol Upgrade**: Switched from standard SpeechSynthesizer to **WebSocket-based Real-time API** (`QwenTtsRealtime`) for synthesis.
- **Cloning Implementation**: Implemented specific REST API calls (`/api/v1/services/audio/tts/customization`) to enroll voices and obtain `voice_id` compatible with the realtime model.
- **Data Handling**: Added PCM-to-MP3 conversion pipeline to handle raw audio streams from the WebSocket API, ensuring correct duration parsing by FFmpeg.

## 2. Audio-Visual Alignment Strategy (The "Two-Layer" Optimization)
To solve the common issue of "translated speech being too fast" or "audio overlap", we implemented a novel two-layer optimization strategy:

### Layer 1: Source Control (Isotonic Translation)
**Goal**: Reduce the need for acceleration by generating concise translations.
**Implementation**: Optimized LLM System Prompts.
> "Translation should be concise and refined. Try to keep the spoken duration of the translation comparable to the original text. This is critical for video dubbing."

This guides the LLM (Qwen) to prefer shorter synonyms and sentence structures that fit the original time slot naturally.

### Layer 2: Post-Processing (Intelligent Acceleration)
**Goal**: Handle inevitable remaining overflows without overlapping or destroying audio quality.
**Implementation**: Smart FFmpeg Processing in `mux` stage.
1. **Overlap Detection**: Calculates `max_available_ms` (time until the next segment starts).
2. **Dynamic Speed Adjustment**:
   - If `Duration(New) <= Duration(Slot)`: No change.
   - If `Duration(New) > Duration(Slot)`: Calculate required speed factor.
3. **Quality Guardrails**:
   - **Limit**: Maximum acceleration set to **4.0x**.
   - **Fallback**: If required speed > 4x (which would make audio unintelligible), the audio is **truncated** to fit the slot rather than accelerating it further.
   - **Filter**: Uses FFmpeg `atempo` filter (with chaining for >2x speeds) to change speed without altering pitch.

## 3. Architecture Improvements
- **Environment**: Standardized on `uv` for Python management and `.env` for configuration.
- **Stability**: Fixed Celery worker loops, Redis connection handling, and event loop conflicts in async tasks.
- **Frontend**: Corrected segment sorting logic to ensure subtitles align with audio.

---
*Generated by AI Assistant, Feb 2026*
