# 系统总览

视频自动配音系统 v2.0 - 完整技术文档

## 🎯 项目概述

这是一个基于阿里云百炼平台的智能视频配音系统，能够自动将视频翻译并配音成多种语言。系统采用现代化的微服务架构，支持多说话人声音复刻，提供完整的 Web 界面。

### 核心功能

✅ **多语言支持**: 支持中、英、日、韩、西、法、德、俄 8 种语言
✅ **智能识别**: 基于阿里云 SenseVoice 的高精度语音识别
✅ **上下文翻译**: 使用 Qwen 大模型进行语义感知翻译
✅ **声音复刻**: 支持保留原视频说话人声音特征
✅ **多说话人处理**: 自动识别并为每个说话人分配声音
✅ **异步处理**: 使用 Celery 任务队列，支持大规模并发
✅ **实时监控**: WebUI 实时显示处理进度和状态

## 🏗️ 技术架构

### 整体架构图

```
┌────────────────────────────────────────────────────────────────┐
│                         用户界面层                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  Next.js 14 Frontend (React + TypeScript + Tailwind)     │ │
│  │  - 视频上传                                               │ │
│  │  - 任务管理                                               │ │
│  │  - 进度监控                                               │ │
│  │  - 结果下载                                               │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/REST API
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                         应用服务层                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  FastAPI Backend (Python 3.10+)                          │ │
│  │  - RESTful API                                            │ │
│  │  - 任务编排                                               │ │
│  │  - 文件管理                                               │ │
│  │  - 状态监控                                               │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              │ Celery Tasks
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                         任务处理层                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  Celery Workers                                           │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐         │ │
│  │  │ Step 1:    │→ │ Step 2:    │→ │ Step 3:    │         │ │
│  │  │ 提取音频   │  │ 语音识别   │  │ 文本翻译   │         │ │
│  │  └────────────┘  └────────────┘  └────────────┘         │ │
│  │         ↓                                                 │ │
│  │  ┌────────────┐  ┌────────────┐                          │ │
│  │  │ Step 4:    │→ │ Step 5:    │                          │ │
│  │  │ 语音合成   │  │ 视频合成   │                          │ │
│  │  └────────────┘  └────────────┘                          │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  PostgreSQL  │    │    Redis     │    │ 阿里云 OSS    │
│              │    │              │    │              │
│  - 任务数据  │    │  - 消息队列  │    │  - 视频存储  │
│  - 分段信息  │    │  - 结果缓存  │    │  - 音频存储  │
│  - 元数据    │    │  - 状态同步  │    │  - 文件管理  │
└──────────────┘    └──────────────┘    └──────────────┘
                              │
                              ▼
                  ┌──────────────────────┐
                  │  阿里云百炼平台       │
                  │                      │
                  │  - ASR (SenseVoice)  │
                  │  - LLM (Qwen)        │
                  │  - TTS (CosyVoice)   │
                  └──────────────────────┘
```

### 技术栈详情

#### 前端
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript 5.3
- **样式**: Tailwind CSS 3.4
- **状态管理**: SWR 2.4 (数据获取与缓存)
- **HTTP 客户端**: Axios 1.6
- **UI 组件**: Radix UI + Lucide Icons
- **表单**: React Hook Form + Zod

#### 后端
- **框架**: FastAPI 0.110
- **语言**: Python 3.10+
- **数据库**: PostgreSQL 14+ (SQLAlchemy 2.0)
- **任务队列**: Celery 5.3 + Redis 6+
- **依赖管理**: uv (Astral)
- **迁移工具**: Alembic

#### 基础设施
- **对象存储**: 阿里云 OSS
- **AI 服务**: 阿里云百炼 DashScope
- **容器化**: Docker + Docker Compose
- **媒体处理**: FFmpeg 4.4+

## 📊 数据模型

### 数据库 ER 图

```
┌─────────────────────────────────────┐
│             Task (任务)              │
├─────────────────────────────────────┤
│ id: UUID (PK)                       │
│ title: String                       │
│ source_language: String             │
│ target_language: String             │
│ status: Enum                        │
│ progress: Integer (0-100)           │
│ current_step: String                │
│ error_message: Text                 │
│ input_video_path: String            │
│ extracted_audio_path: String        │
│ output_video_path: String           │
│ video_duration_ms: Integer          │
│ segment_count: Integer              │
│ celery_task_id: String              │
│ created_at: DateTime                │
│ updated_at: DateTime                │
│ completed_at: DateTime              │
└─────────────────────────────────────┘
                │
                │ 1:N
                ▼
┌─────────────────────────────────────┐
│          Segment (分段)              │
├─────────────────────────────────────┤
│ id: UUID (PK)                       │
│ task_id: UUID (FK)                  │
│ segment_index: Integer              │
│ start_time_ms: Integer              │
│ end_time_ms: Integer                │
│ original_text: Text                 │
│ translated_text: Text               │
│ speaker_id: String                  │
│ emotion: String                     │
│ confidence: Float                   │
│ voice_id: String                    │
│ audio_path: String                  │
│ created_at: DateTime                │
│ updated_at: DateTime                │
└─────────────────────────────────────┘
```

### 状态机

```
        ┌─────────┐
        │ PENDING │
        └─────────┘
             │
             ▼
      ┌────────────┐
      │ EXTRACTING │ ─── 提取音频
      └────────────┘
             │
             ▼
     ┌─────────────┐
     │TRANSCRIBING │ ─── 语音识别
     └─────────────┘
             │
             ▼
     ┌─────────────┐
     │ TRANSLATING │ ─── 文本翻译
     └─────────────┘
             │
             ▼
    ┌──────────────┐
    │SYNTHESIZING  │ ─── 语音合成
    └──────────────┘
             │
             ▼
        ┌────────┐
        │ MUXING │ ─── 视频合成
        └────────┘
             │
             ▼
       ┌───────────┐
       │ COMPLETED │
       └───────────┘

    任何阶段都可能转到:
       ┌────────┐
       │ FAILED │
       └────────┘
```

## 🔄 处理流程

### 完整处理链路

```
1️⃣ 用户上传视频
   │
   ▼
2️⃣ FastAPI 接收文件
   ├─ 验证文件格式和大小
   ├─ 创建任务记录
   └─ 上传到 OSS
   │
   ▼
3️⃣ 提交 Celery 任务链
   │
   ▼
┌──────────────────────────────────────┐
│  Celery Worker 异步处理              │
├──────────────────────────────────────┤
│                                      │
│  Step 1: extract_audio               │
│  ├─ 从 OSS 下载视频                  │
│  ├─ FFmpeg 提取音频 (WAV)            │
│  ├─ 获取视频元数据                   │
│  └─ 上传音频到 OSS                   │
│                                      │
│  Step 2: transcribe_audio            │
│  ├─ 下载音频文件                     │
│  ├─ 调用 DashScope ASR API           │
│  ├─ 接收识别结果（句子+说话人）      │
│  └─ 创建 Segment 记录                │
│                                      │
│  Step 3: translate_segments          │
│  ├─ 读取所有分段                     │
│  ├─ 调用 DashScope LLM API           │
│  ├─ 批量翻译文本                     │
│  └─ 更新 Segment 翻译                │
│                                      │
│  Step 4: synthesize_audio            │
│  ├─ 按说话人分组                     │
│  ├─ 为每个说话人复刻声音（可选）     │
│  │  └─ 调用 DashScope TTS Enroll API │
│  ├─ 使用 voice_id 合成音频           │
│  └─ 上传分段音频到 OSS               │
│                                      │
│  Step 5: mux_video                   │
│  ├─ 下载所有分段音频                 │
│  ├─ FFmpeg 合并音频                  │
│  ├─ FFmpeg 替换视频音轨              │
│  └─ 上传最终视频到 OSS               │
│                                      │
└──────────────────────────────────────┘
   │
   ▼
4️⃣ 任务完成
   ├─ 更新任务状态
   ├─ 记录完成时间
   └─ 通知前端
   │
   ▼
5️⃣ 用户下载结果
   ├─ 生成 OSS 签名 URL
   └─ 提供下载链接（1小时有效）
```

## 📡 API 接口

### 核心端点

#### 任务管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/tasks` | 创建配音任务 |
| GET | `/api/v1/tasks` | 获取任务列表（支持分页和过滤） |
| GET | `/api/v1/tasks/{id}` | 获取任务详情 |
| DELETE | `/api/v1/tasks/{id}` | 删除任务 |
| GET | `/api/v1/tasks/{id}/result` | 获取下载链接 |

#### 监控

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/monitoring/health` | 健康检查 |
| GET | `/api/v1/monitoring/stats` | 系统统计 |
| GET | `/api/v1/monitoring/celery/inspect` | Celery 状态 |

### 请求示例

**创建任务**

```bash
curl -X POST http://localhost:8000/api/v1/tasks \
  -F "video=@test.mp4" \
  -F "source_language=zh" \
  -F "target_language=en" \
  -F "title=测试视频"
```

**查询任务**

```bash
curl http://localhost:8000/api/v1/tasks/550e8400-e29b-41d4-a716-446655440000
```

**下载结果**

```bash
curl http://localhost:8000/api/v1/tasks/550e8400-e29b-41d4-a716-446655440000/result
```

## 🔐 安全性

### 数据安全

1. **文件验证**: 严格的文件类型和大小检查
2. **SQL 注入防护**: 使用 SQLAlchemy ORM 和参数化查询
3. **XSS 防护**: 前端输入验证和内容转义
4. **CORS 配置**: 限制允许的来源域名

### API 安全

1. **签名 URL**: OSS 下载链接使用临时签名（1小时有效）
2. **速率限制**: 防止 API 滥用（待实现）
3. **认证机制**: JWT 认证（待实现）

### 数据隐私

1. **数据隔离**: 任务文件按 ID 独立存储
2. **自动清理**: 可配置的文件保留期限（待实现）
3. **访问控制**: 基于用户的权限管理（待实现）

## 📈 性能指标

### 处理性能

| 视频时长 | 处理时间 | 备注 |
|---------|---------|------|
| 1 分钟 | ~2-3 分钟 | 单说话人，系统音色 |
| 5 分钟 | ~8-12 分钟 | 单说话人，系统音色 |
| 1 分钟 | ~3-5 分钟 | 多说话人，声音复刻 |
| 5 分钟 | ~12-20 分钟 | 多说话人，声音复刻 |

### 系统容量

- **并发任务**: 取决于 Worker 数量（推荐 4-8 个）
- **最大文件**: 500 MB（可配置）
- **支持格式**: MP4, AVI, MOV, MKV, FLV
- **最大时长**: 无限制（受存储和时间约束）

### 优化建议

1. **增加 Worker**: 提高并发处理能力
2. **使用 CDN**: 加速 OSS 文件访问
3. **Redis 集群**: 提高任务队列吞吐量
4. **数据库优化**: 添加索引，使用连接池
5. **缓存策略**: 缓存频繁访问的数据

## 🛠️ 运维管理

### 日志系统

```
backend/
├── logs/
│   └── app.log          # API 日志
├── backend.log           # 后端服务日志
└── worker.log            # Worker 日志

frontend/
└── frontend.log          # 前端日志
```

### 监控指标

1. **任务指标**
   - 总任务数
   - 各状态任务数
   - 成功率
   - 平均处理时间

2. **系统指标**
   - CPU 使用率
   - 内存使用率
   - 磁盘空间
   - 网络流量

3. **服务健康**
   - PostgreSQL 连接状态
   - Redis 连接状态
   - FFmpeg 可用性
   - DashScope API 状态

### 备份策略

1. **数据库备份**
   ```bash
   pg_dump dubbing > backup_$(date +%Y%m%d).sql
   ```

2. **OSS 备份**
   - 使用阿里云 OSS 版本控制
   - 定期导出重要文件清单

3. **配置备份**
   - 定期备份 `.env` 文件
   - 版本控制敏感配置

## 🚀 扩展性

### 水平扩展

```
┌─────────────┐
│  Load       │
│  Balancer   │
└─────────────┘
       │
       ├─────────────┬─────────────┬─────────────┐
       │             │             │             │
       ▼             ▼             ▼             ▼
  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐
  │FastAPI │    │FastAPI │    │FastAPI │    │FastAPI │
  │  #1    │    │  #2    │    │  #3    │    │  #4    │
  └────────┘    └────────┘    └────────┘    └────────┘
       │             │             │             │
       └─────────────┴─────────────┴─────────────┘
                     │
                     ▼
              ┌─────────────┐
              │  PostgreSQL │
              │   (Master)  │
              └─────────────┘
                     │
              ┌──────┴──────┐
              │             │
              ▼             ▼
       ┌───────────┐ ┌───────────┐
       │PostgreSQL │ │PostgreSQL │
       │ (Replica) │ │ (Replica) │
       └───────────┘ └───────────┘

  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐
  │ Worker │    │ Worker │    │ Worker │    │ Worker │
  │  #1    │    │  #2    │    │  #3    │    │  #4    │
  └────────┘    └────────┘    └────────┘    └────────┘
       │             │             │             │
       └─────────────┴─────────────┴─────────────┘
                     │
                     ▼
              ┌─────────────┐
              │    Redis    │
              │   Cluster   │
              └─────────────┘
```

### 功能扩展

#### 短期计划
- [ ] 用户认证和授权
- [ ] 批量任务处理
- [ ] 自定义音色选择
- [ ] 字幕导出功能
- [ ] 实时 WebSocket 通知

#### 长期计划
- [ ] 多租户支持
- [ ] 配额管理
- [ ] 付费订阅
- [ ] API Key 管理
- [ ] Webhook 回调

## 📚 文档索引

| 文档 | 路径 | 说明 |
|------|------|------|
| 快速启动 | `/QUICKSTART.md` | 系统快速启动指南 |
| API 文档 | `/backend/API_DOCUMENTATION.md` | 完整的 API 接口文档 |
| 后端说明 | `/backend/README.md` | 后端开发指南 |
| 前端说明 | `/frontend/README.md` | 前端开发指南 |
| 部署指南 | `/backend/DEPLOYMENT.md` | 生产部署指南 |
| 多说话人 | `/backend/MULTI_SPEAKER_GUIDE.md` | 声音复刻使用指南 |
| 项目总览 | `/DEEPV.md` | 项目上下文和重构说明 |

## 🤝 贡献指南

### 开发流程

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

### 代码规范

**Python (后端)**
- 遵循 PEP 8 规范
- 使用 Black 格式化
- 使用 Ruff 进行 lint
- 类型注解覆盖率 > 80%

**TypeScript (前端)**
- 遵循 ESLint 配置
- 使用 Prettier 格式化
- 严格模式 TypeScript
- 组件函数式编程

### 测试要求

- 单元测试覆盖率 > 70%
- 所有 API 端点有集成测试
- 关键业务逻辑有 E2E 测试

## 📞 支持

- **文档**: http://localhost:8000/api/v1/docs
- **Issues**: https://github.com/your-repo/issues
- **Email**: support@example.com

## 📄 许可证

MIT License - 详见 LICENSE 文件

## 🙏 致谢

- **阿里云百炼平台**: 提供 ASR、LLM、TTS 服务
- **FastAPI**: 现代化的 Python Web 框架
- **Next.js**: React 全栈框架
- **Celery**: 分布式任务队列
- **PostgreSQL**: 强大的关系型数据库
- **Redis**: 高性能缓存和消息队列
- **FFmpeg**: 音视频处理工具

---

**版本**: 2.0.0
**更新时间**: 2026-02-02
**维护者**: DeepV Team
